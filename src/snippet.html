<style>
    .snippet-container {
        max-width: 860px;
        margin: 24px auto;
        padding: 24px;
        border: 1px solid #EAEAF0;
        border-radius: 16px;
        background: #FFFFFF;
        font-family: Inter, system-ui, Segoe UI, Roboto, Arial
    }

    .snippet-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px
    }

    h4 {
        margin: 0 0 6px;
        color: #1B1F3B;
        font-size: 22px;
        font-weight: 700;
    }

    .snippet-label {
        display: block;
        margin: 8px 0 6px;
        color: #1B1F3B;
        font-weight: 600
    }

    .snippet-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #dfe3ea;
        border-radius: 12px;
        background: #F7F8FA;
        color: #1B1F3B
    }

    .snippet-button {
        width: 100%;
        padding: 12px 16px;
        border: 0;
        border-radius: 12px;
        background: #2C7CFF;
        color: #FFFFFF;
        font-weight: 700;
        cursor: pointer
    }
</style>
<div class="snippet-container">
    <h4>
        <span>Convierte tus Tokens a USD y COP</span>
    </h4>
    <form onsubmit="event.preventDefault(); calculateTokenAmount();">
        <div class="snippet-grid">
            <div class="">
                <label for="platform-select" class="snippet-label">Plataforma</label>
                <select id="platform-select" class="snippet-input">
                    <option value="chaturbate">Chaturbate (tokens)</option>
                    <option value="stripchat">Stripchat (tokens)</option>
                    <option value="bongacams">BongaCams (tokens)</option>
                    <option value="onlyfans">OnlyFans (USD directos)</option>
                </select>
            </div>
            <div class="">
                <label for="usd-per-token-input" class="snippet-label">USD por token</label>
                <input id="usd-per-token-input" type="number" min="0" step="0.01" value="0.05" required
                    class="snippet-input">
            </div>
            <div class="">
                <label for="tokens-amount-input" class="snippet-label">Tokens</label>
                <input id="tokens-amount-input" type="number" min="0" step="1" placeholder="Ej: 1000" required
                    class="snippet-input">
            </div>
            <div class="">
                <label for="trm-input" class="snippet-label">TRM</label>
                <input id="trm-input" type="number" readonly class="snippet-input">
            </div>

            <button id="calculate-btn" class="snippet-button" type="submit">Calcular</button>
            
            <div class="">
                <label for="trm-input" class="input__label--light input__label">COP</label>
                <input id="total-cop-result-input" type="text" readonly class="snippet-input">
            </div>

        </div>
    </form>
</div>
<script>
    const TRM_STORAGE_KEY = "trm_usd_cop";
    const trmIncreaseAmount = 100;
    (async function () {
        // This self-executing function loads the TRM when the snippet is loaded
        let trmValue = undefined;
        const cachedTrm = getTrmFromLocalStorage();
        if (!cachedTrm) {
            try {
                trmValue = await fetchTrm();
                saveTrmToLocalStorage(trmValue);
            } catch (error) {
                console.error("Error fetching TRM:", error);
            }
        } else {
            trmValue = cachedTrm;
        }

        const trmInput = document.getElementById("trm-input");
        if (trmValue) {
            trmValue += trmIncreaseAmount;
            trmInput.value = trmValue.toFixed(2);
        } else {
            trmInput.placeholder = "No se pudo cargar la TRM. Por favor ingr√©sala manualmente.";
            trmInput.removeAttribute("readonly");
        }
    })();

    function getTrmFromLocalStorage() {
        const trmData = localStorage.getItem(TRM_STORAGE_KEY);
        if (!trmData) {
            return null;
        }
        const parsed = JSON.parse(trmData);
        const now = new Date();
        const trmCacheInterval = (24 * 60 * 60 * 1000) / 3; // three times per day
        if (now.getTime() - parsed.timestamp < trmCacheInterval) {
            return parsed.value;
        }
        return null;
    }

    function saveTrmToLocalStorage(value) {
        const trmData = {
            value: value,
            timestamp: new Date().getTime()
        };
        localStorage.setItem(TRM_STORAGE_KEY, JSON.stringify(trmData));
    }

    async function fetchTrm() {
        const response = await fetch("https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=COP&apikey=0GWG9IP1VB1J3E0E");
        const data = await response.json();
        const valueStr = data["Realtime Currency Exchange Rate"]["5. Exchange Rate"];
        if (isNaN(valueStr)) {
            throw new Error("Invalid TRM value from API");
        }
        return parseFloat(valueStr);
    }

    function calculateTokenAmount() {
        const platformSelect = document.getElementById("platform-select");
        const usdPerTokenInput = document.getElementById("usd-per-token-input");
        const tokensAmountInput = document.getElementById("tokens-amount-input");
        const trmInput = document.getElementById("trm-input");

        const platform = platformSelect.value;
        const usdPerToken = parseFloat(usdPerTokenInput.value);
        const tokensAmount = parseFloat(tokensAmountInput.value);
        const trm = parseFloat(trmInput.value);

        let usdAmount = 0;
        if (platform === "onlyfans") {
            usdAmount = tokensAmount; // Direct USD input
        } else {
            usdAmount = tokensAmount * usdPerToken; // Tokens to USD conversion
        }

        const copAmount = usdAmount * trm;

        document.getElementById("total-cop-result-input").value = formatCOP(copAmount);

        return false; // Prevent form submission
    }

    const formatCOP = (v) => isNaN(v) ? "-" : new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 0 }).format(v);
</script>